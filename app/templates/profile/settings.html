{% extends 'base.html' %}
{% load static %}

{% block title %}–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è ‚Äî SkillsSpire{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
            <div class="mb-5">
                <h1 class="h2 fw-bold mb-3">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è</h1>
                <p class="text-muted">–£–ø—Ä–∞–≤–ª—è–π—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –≤–∞—à–µ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏</p>
            </div>

            <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
            {% if messages %}
            <div class="mb-4">
                {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- –§–æ—Ä–º–∞ —Å –≤–∫–ª–∞–¥–∫–∞–º–∏ -->
            <div class="card shadow border-0">
                <div class="card-body p-4">
                    <ul class="nav nav-pills mb-4" id="settingsTabs">
                        <li class="nav-item me-2">
                            <button class="nav-link {% if active_tab == 'profile' %}active{% endif %}" 
                                    data-bs-target="#profile" data-bs-toggle="tab">
                                üë§ –ü—Ä–æ—Ñ–∏–ª—å
                            </button>
                        </li>
                        <li class="nav-item me-2">
                            <button class="nav-link {% if active_tab == 'security' %}active{% endif %}" 
                                    data-bs-target="#security" data-bs-toggle="tab">
                                üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link {% if active_tab == 'notifications' %}active{% endif %}" 
                                    data-bs-target="#notifications" data-bs-toggle="tab">
                                üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content">
                        
                        <!-- –í–∫–ª–∞–¥–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è -->
                        <div class="tab-pane fade {% if active_tab == 'profile' %}show active{% endif %}" id="profile">
                            <form method="post" enctype="multipart/form-data">
                                {% csrf_token %}
                                <input type="hidden" name="update_profile" value="1">
                                
                                <!-- –ê–≤–∞—Ç–∞—Ä -->
                                <div class="mb-4 text-center">
                                    <div class="avatar-upload mb-3 position-relative d-inline-block">
                                        {% if user.avatar %}
                                            <img src="{{ user.avatar.url }}" class="rounded-circle avatar-preview" 
                                                 width="120" height="120" alt="–ê–≤–∞—Ç–∞—Ä" style="object-fit: cover;">
                                        {% else %}
                                            <div class="avatar-placeholder rounded-circle d-inline-flex align-items-center justify-content-center" 
                                                 style="width:120px; height:120px; background:#01349D; color:white; font-size:2.5rem;">
                                                {{ user.first_name|first|default:user.email|first|upper }}
                                            </div>
                                        {% endif %}
                                        <div class="position-absolute bottom-0 end-0 bg-primary rounded-circle p-2">
                                            <i class="fas fa-camera text-white"></i>
                                        </div>
                                    </div>
                                    <div class="w-50 mx-auto">
                                        <input type="file" name="avatar" class="form-control form-control-sm" accept="image/*">
                                        <small class="text-muted">–ú–∞–∫—Å. 2MB. JPG, PNG —Ñ–æ—Ä–º–∞—Ç—ã.</small>
                                    </div>
                                </div>

                                <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-semibold">–ò–º—è</label>
                                        <input type="text" name="first_name" class="form-control" 
                                               value="{{ user.first_name|default:'' }}" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-semibold">–§–∞–º–∏–ª–∏—è</label>
                                        <input type="text" name="last_name" class="form-control" 
                                               value="{{ user.last_name|default:'' }}">
                                    </div>
                                </div>

                                <div class="mb-4">
                                    <label class="form-label fw-semibold">Email</label>
                                    <input type="email" class="form-control" value="{{ user.email }}" disabled>
                                    <small class="text-muted">–î–ª—è —Å–º–µ–Ω—ã email –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É</small>
                                </div>

                                <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                                <h5 class="fw-semibold mb-3">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h5>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                                        <input type="tel" name="phone" class="form-control" 
                                               value="{{ user.profile.phone|default:'' }}">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">–ö–æ–º–ø–∞–Ω–∏—è</label>
                                        <input type="text" name="company" class="form-control" 
                                               value="{{ user.profile.company|default:'' }}">
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">–î–æ–ª–∂–Ω–æ—Å—Ç—å</label>
                                        <input type="text" name="position" class="form-control" 
                                               value="{{ user.profile.position|default:'' }}">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">–í–µ–±-—Å–∞–π—Ç</label>
                                        <input type="url" name="website" class="form-control" 
                                               value="{{ user.profile.website|default:'' }}">
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">–°—Ç—Ä–∞–Ω–∞</label>
                                        <input type="text" name="country" class="form-control" 
                                               value="{{ user.profile.country|default:'' }}">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">–ì–æ—Ä–æ–¥</label>
                                        <input type="text" name="city" class="form-control" 
                                               value="{{ user.profile.city|default:'' }}">
                                    </div>
                                </div>

                                <div class="mb-4">
                                    <label class="form-label">–û —Å–µ–±–µ</label>
                                    <textarea name="bio" class="form-control" rows="3" 
                                              placeholder="–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —Å–µ–±–µ, —Å–≤–æ–µ–º –æ–ø—ã—Ç–µ –∏ –∏–Ω—Ç–µ—Ä–µ—Å–∞—Ö...">{{ user.profile.bio|default:'' }}</textarea>
                                </div>

                                <div class="d-flex justify-content-between">
                                    <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary">
                                        ‚Üê –ù–∞–∑–∞–¥ –≤ –∫–∞–±–∏–Ω–µ—Ç
                                    </a>
                                    <button type="submit" class="btn btn-primary px-4">
                                        <i class="fas fa-save me-2"></i>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- –í–∫–ª–∞–¥–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ -->
                        <div class="tab-pane fade {% if active_tab == 'security' %}show active{% endif %}" id="security">
                            <form method="post">
                                {% csrf_token %}
                                <input type="hidden" name="change_password" value="1">
                                
                                <div class="mb-4">
                                    <h5 class="fw-semibold mb-3">–°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è</h5>
                                    
                                    <div class="mb-3">
                                        <label class="form-label">–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å</label>
                                        <input type="password" name="current_password" class="form-control" required>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
                                        <input type="password" name="new_password1" class="form-control" required>
                                        <small class="text-muted">–ú–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤</small>
                                    </div>

                                    <div class="mb-4">
                                        <label class="form-label">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
                                        <input type="password" name="new_password2" class="form-control" required>
                                    </div>

                                    <div class="d-flex justify-content-between">
                                        <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary">
                                            ‚Üê –ù–∞–∑–∞–¥ –≤ –∫–∞–±–∏–Ω–µ—Ç
                                        </a>
                                        <button type="submit" class="btn btn-primary px-4">
                                            <i class="fas fa-key me-2"></i>–°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å
                                        </button>
                                    </div>
                                </div>

                                <!-- –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç–∞ -->
                                <div class="mt-5 pt-4 border-top">
                                    <h5 class="fw-semibold mb-3">–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç–∞</h5>
                                    <div class="alert alert-warning">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        <strong>–í–∞–∂–Ω–æ:</strong>
                                        –î–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –≤–∫–ª—é—á–∏—Ç–µ –¥–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω—É—é –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é.
                                        <div class="mt-2">
                                            <button type="button" class="btn btn-outline-warning btn-sm" disabled>
                                                <i class="fas fa-shield-alt me-1"></i>
                                                –í–∫–ª—é—á–∏—Ç—å 2FA (–°–∫–æ—Ä–æ)
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>

                        <!-- –í–∫–ª–∞–¥–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
                        <div class="tab-pane fade {% if active_tab == 'notifications' %}show active{% endif %}" id="notifications">
                            <form method="post">
                                {% csrf_token %}
                                <input type="hidden" name="update_notifications" value="1">
                                
                                <h5 class="fw-semibold mb-3">Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h5>
                                
                                <div class="form-check form-switch mb-3 p-0">
                                    <div class="d-flex align-items-center justify-content-between p-3 border rounded">
                                        <div>
                                            <label class="form-check-label fw-semibold" for="email_notifications">
                                                üìß –í—Å–µ email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                                            </label>
                                            <p class="small text-muted mb-0">
                                                –ü–æ–ª—É—á–∞–π—Ç–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ –∫—É—Ä—Å–∞—Ö, —É—Ä–æ–∫–∞—Ö –∏ –∞–Ω–æ–Ω—Å–∞—Ö
                                            </p>
                                        </div>
                                        <input class="form-check-input m-0" type="checkbox" name="email_notifications" 
                                               id="email_notifications" style="width: 50px; height: 26px;"
                                               {% if user.profile.email_notifications|default:True %}checked{% endif %}>
                                    </div>
                                </div>

                                <div class="form-check form-switch mb-3 p-0">
                                    <div class="d-flex align-items-center justify-content-between p-3 border rounded">
                                        <div>
                                            <label class="form-check-label fw-semibold" for="course_updates">
                                                üéì –û–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫—É—Ä—Å–æ–≤
                                            </label>
                                            <p class="small text-muted mb-0">
                                                –ù–æ–≤—ã–µ —É—Ä–æ–∫–∏, –º–∞—Ç–µ—Ä–∏–∞–ª—ã –∏ –∞–Ω–æ–Ω—Å—ã –≤ –≤–∞—à–∏—Ö –∫—É—Ä—Å–∞—Ö
                                            </p>
                                        </div>
                                        <input class="form-check-input m-0" type="checkbox" name="course_updates" 
                                               id="course_updates" style="width: 50px; height: 26px;"
                                               {% if user.profile.course_updates|default:True %}checked{% endif %}>
                                    </div>
                                </div>

                                <div class="form-check form-switch mb-3 p-0">
                                    <div class="d-flex align-items-center justify-content-between p-3 border rounded">
                                        <div>
                                            <label class="form-check-label fw-semibold" for="newsletter">
                                                üì∞ –†–∞—Å—Å—ã–ª–∫–∞ –∏ –ø—Ä–æ–º–æ–∞–∫—Ü–∏–∏
                                            </label>
                                            <p class="small text-muted mb-0">
                                                –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –Ω–æ–≤—ã–µ –∫—É—Ä—Å—ã –∏ –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç
                                            </p>
                                        </div>
                                        <input class="form-check-input m-0" type="checkbox" name="newsletter" 
                                               id="newsletter" style="width: 50px; height: 26px;"
                                               {% if user.profile.newsletter|default:False %}checked{% endif %}>
                                    </div>
                                </div>

                                <h5 class="fw-semibold mb-3 mt-4">Push —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h5>
                                
                                <div class="form-check form-switch mb-3 p-0">
                                    <div class="d-flex align-items-center justify-content-between p-3 border rounded">
                                        <div>
                                            <label class="form-check-label fw-semibold" for="push_reminders">
                                                ‚è∞ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ–± –æ–±—É—á–µ–Ω–∏–∏
                                            </label>
                                            <p class="small text-muted mb-0">
                                                –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –Ω–µ–∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö —É—Ä–æ–∫–∞—Ö –∏ –∫—É—Ä—Å–∞—Ö
                                            </p>
                                        </div>
                                        <input class="form-check-input m-0" type="checkbox" name="push_reminders" 
                                               id="push_reminders" style="width: 50px; height: 26px;"
                                               {% if user.profile.push_reminders|default:True %}checked{% endif %}>
                                    </div>
                                </div>

                                <div class="d-flex justify-content-between mt-4">
                                    <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary">
                                        ‚Üê –ù–∞–∑–∞–¥ –≤ –∫–∞–±–∏–Ω–µ—Ç
                                    </a>
                                    <button type="submit" class="btn btn-primary px-4">
                                        <i class="fas fa-save me-2"></i>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
            <div class="mt-4 text-center text-muted small">
                <p>
                    –ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å? 
                    <a href="mailto:support@skillsspire.com" class="text-decoration-none">
                        support@skillsspire.com
                    </a>
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
:root {
    --primary-color: #01349D;
    --primary-light: #3b5cc5;
}

.avatar-upload {
    cursor: pointer;
    transition: transform 0.2s;
}

.avatar-upload:hover {
    transform: scale(1.05);
}

.avatar-preview {
    border: 3px solid var(--primary-color);
    box-shadow: 0 4px 12px rgba(1, 52, 157, 0.15);
}

.nav-pills .nav-link {
    color: var(--primary-color);
    border: 1px solid var(--primary-color);
    margin-right: 8px;
    margin-bottom: 8px;
    border-radius: 8px;
}

.nav-pills .nav-link.active {
    background-color: var(--primary-color);
    color: white;
}

.form-check-input:checked {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
}

.border-top {
    border-top: 1px solid #e5e7eb !important;
}

.btn-primary {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
}

.btn-primary:hover {
    background-color: var(--primary-light);
    border-color: var(--primary-light);
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∞–≤–∞—Ç–∞—Ä–∞
document.addEventListener('DOMContentLoaded', function() {
    const avatarInput = document.querySelector('input[name="avatar"]');
    const avatarPreview = document.querySelector('.avatar-preview, .avatar-placeholder');
    
    if (avatarInput && avatarPreview) {
        avatarInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    if (avatarPreview.tagName === 'IMG') {
                        avatarPreview.src = e.target.result;
                    } else {
                        // –ó–∞–º–µ–Ω—è–µ–º placeholder –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.className = 'rounded-circle avatar-preview';
                        img.style.width = '120px';
                        img.style.height = '120px';
                        img.style.objectFit = 'cover';
                        img.style.border = '3px solid #01349D';
                        avatarPreview.parentNode.replaceChild(img, avatarPreview);
                    }
                }
                reader.readAsDataURL(file);
            }
        });
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞
    if (avatarInput) {
        avatarInput.addEventListener('change', function() {
            const file = this.files[0];
            if (file && file.size > 2 * 1024 * 1024) { // 2MB
                alert('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π! –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 2MB.');
                this.value = '';
            }
        });
    }
});
</script>
{% endblock %}